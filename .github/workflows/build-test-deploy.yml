name: ğŸš€ Test & Deploy AI Interview

on:
  push:
    branches:
      - "*"

jobs:
  docker-build-test:
    name: ğŸ³ Build Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 5  # Fetch some history to get commit information

      - name: ğŸ”¨ Build Docker Image
        run: |
          echo "ğŸ§ª Building Docker image for test..."
          docker build -t app-test .
          
  deploy-prod:
    name: ğŸš€ Deploy AI Interview (Prod)
    runs-on: ubuntu-latest
    environment:
      name: prod-wms-general
      url: hhttps://wms-dev.logspace.id/
    needs: docker-build-test

    steps:
      - name: ğŸš€ Deploy AI Interview via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST_PROD }}
          username: ${{ secrets.SSH_USERNAME_PROD }}
          key: ${{ secrets.SSH_KEY_PROD }}
          script: |
            echo "ğŸš€ Deploying AI Interview API..."
            cd ${{ secrets.WORKDIR_PROD }}
            git pull origin main &&

            echo "ğŸ”§ Rebuilding Docker containers..."
            docker compose build &&

            echo "ğŸ“¦ Starting services..."
            docker compose up -d &&

            echo "âœ… AI Interview deployed!"
            sleep 5 && docker ps -a
